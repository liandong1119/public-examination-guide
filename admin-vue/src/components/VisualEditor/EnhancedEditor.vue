<template>
  <div class="enhanced-editor">
    <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
    <div class="main-toolbar">
      <div class="toolbar-section">
        <el-button-group>
          <el-button @click="newDocument" title="Êñ∞Âª∫ (Ctrl+N)">
            <el-icon><DocumentAdd /></el-icon>
            Êñ∞Âª∫
          </el-button>
          <el-button @click="openDocument" title="ÊâìÂºÄ (Ctrl+O)">
            <el-icon><FolderOpened /></el-icon>
            ÊâìÂºÄ
          </el-button>
          <el-button @click="saveDocument" title="‰øùÂ≠ò (Ctrl+S)" :loading="isSaving">
            <el-icon><Document /></el-icon>
            ‰øùÂ≠ò
          </el-button>
          <el-button @click="exportDocument" title="ÂØºÂá∫">
            <el-icon><Download /></el-icon>
            ÂØºÂá∫
          </el-button>
        </el-button-group>
      </div>

      <div class="toolbar-section">
        <el-button-group>
          <el-button @click="undo" :disabled="!canUndo" title="Êí§ÈîÄ (Ctrl+Z)">
            <el-icon><RefreshLeft /></el-icon>
          </el-button>
          <el-button @click="redo" :disabled="!canRedo" title="ÈáçÂÅö (Ctrl+Y)">
            <el-icon><RefreshRight /></el-icon>
          </el-button>
        </el-button-group>
      </div>

      <div class="toolbar-section">
        <el-select v-model="currentMode" @change="switchMode" style="width: 150px;">
          <el-option label="üìù ÊñáÊú¨ÁºñËæë" value="text" />
          <el-option label="üé® ÂõæÂΩ¢ËÆæËÆ°" value="graphic" />
          <el-option label="üìê ÂÖ¨ÂºèÁºñËæë" value="formula" />
          <el-option label="üìä ÂõæË°®Âà∂‰Ωú" value="chart" />
          <el-option label="üß© ÁªÑ‰ª∂ÁªÑÂêà" value="component" />
        </el-select>
      </div>

      <div class="toolbar-section">
        <el-button-group>
          <el-button @click="togglePreview" :type="showPreview ? 'primary' : 'default'" title="È¢ÑËßà">
            <el-icon><View /></el-icon>
            È¢ÑËßà
          </el-button>
          <el-button @click="toggleFullscreen" title="ÂÖ®Â±è (F11)">
            <el-icon><FullScreen /></el-icon>
          </el-button>
        </el-button-group>
      </div>
    </div>

    <!-- ÁºñËæëÂô®‰∏ª‰Ωì -->
    <div class="editor-body" :class="{ 'fullscreen': isFullscreen }">
      <!-- Â∑¶‰æßÂ∑•ÂÖ∑Èù¢Êùø -->
      <div class="left-panel" v-show="!isFullscreen">
        <el-tabs v-model="activePanel" tab-position="left" class="panel-tabs">
          <!-- Â∑•ÂÖ∑Èù¢Êùø -->
          <el-tab-pane label="üõ†Ô∏è" name="tools">
            <div class="tools-panel">
              <h4>Â∑•ÂÖ∑ÁÆ±</h4>
              
              <!-- ÊñáÊú¨Â∑•ÂÖ∑ -->
              <div v-if="currentMode === 'text'" class="tool-category">
                <h5>ÊñáÊú¨Ê†ºÂºè</h5>
                <div class="tool-grid">
                  <el-button size="small" @click="insertText('# ')" title="Ê†áÈ¢ò1">H1</el-button>
                  <el-button size="small" @click="insertText('## ')" title="Ê†áÈ¢ò2">H2</el-button>
                  <el-button size="small" @click="insertText('**Á≤ó‰Ωì**')" title="Á≤ó‰Ωì">B</el-button>
                  <el-button size="small" @click="insertText('*Êñú‰Ωì*')" title="Êñú‰Ωì">I</el-button>
                  <el-button size="small" @click="insertText('`‰ª£Á†Å`')" title="Ë°åÂÜÖ‰ª£Á†Å">Code</el-button>
                  <el-button size="small" @click="insertText('> ')" title="ÂºïÁî®">Quote</el-button>
                </div>
              </div>

              <!-- ÂÖ¨ÂºèÂ∑•ÂÖ∑ -->
              <div v-if="currentMode === 'formula'" class="tool-category">
                <h5>Âø´ÈÄüÊèíÂÖ•</h5>
                <div class="formula-quick-tools">
                  <el-button size="small" @click="insertFormula('\\frac{a}{b}')" title="ÂàÜÊï∞">a/b</el-button>
                  <el-button size="small" @click="insertFormula('x^{2}')" title="‰∏äÊ†á">x¬≤</el-button>
                  <el-button size="small" @click="insertFormula('x_{n}')" title="‰∏ãÊ†á">x‚Çô</el-button>
                  <el-button size="small" @click="insertFormula('\\sqrt{x}')" title="Ê†πÂè∑">‚àöx</el-button>
                  <el-button size="small" @click="insertFormula('\\sum_{i=1}^{n}')" title="Ê±ÇÂíå">Œ£</el-button>
                  <el-button size="small" @click="insertFormula('\\int_{a}^{b}')" title="ÁßØÂàÜ">‚à´</el-button>
                </div>
              </div>

              <!-- ÂõæÂΩ¢Â∑•ÂÖ∑ -->
              <div v-if="currentMode === 'graphic'" class="tool-category">
                <h5>Âü∫Á°ÄÂΩ¢Áä∂</h5>
                <div class="shape-tools">
                  <el-button size="small" @click="addShape('rectangle')" title="Áü©ÂΩ¢">‚ñ°</el-button>
                  <el-button size="small" @click="addShape('circle')" title="ÂúÜÂΩ¢">‚óã</el-button>
                  <el-button size="small" @click="addShape('triangle')" title="‰∏âËßíÂΩ¢">‚ñ≥</el-button>
                  <el-button size="small" @click="addShape('line')" title="Áõ¥Á∫ø">‚Äî</el-button>
                  <el-button size="small" @click="addShape('arrow')" title="ÁÆ≠Â§¥">‚Üí</el-button>
                  <el-button size="small" @click="addShape('text')" title="ÊñáÊú¨">T</el-button>
                </div>
              </div>
            </div>
          </el-tab-pane>

          <!-- Â±ûÊÄßÈù¢Êùø -->
          <el-tab-pane label="‚öôÔ∏è" name="properties">
            <div class="properties-panel">
              <h4>Â±ûÊÄßËÆæÁΩÆ</h4>
              <div v-if="selectedObject" class="property-groups">
                <!-- ‰ΩçÁΩÆÂíåÂ§ßÂ∞è -->
                <el-collapse v-model="activePropertyGroups">
                  <el-collapse-item title="‰ΩçÁΩÆÂíåÂ§ßÂ∞è" name="transform">
                    <div class="property-grid">
                      <el-input-number v-model="objectProperties.x" label="X:" size="small" />
                      <el-input-number v-model="objectProperties.y" label="Y:" size="small" />
                      <el-input-number v-model="objectProperties.width" label="ÂÆΩ:" size="small" />
                      <el-input-number v-model="objectProperties.height" label="È´ò:" size="small" />
                      <el-input-number v-model="objectProperties.rotation" label="ÊóãËΩ¨:" size="small" />
                    </div>
                  </el-collapse-item>

                  <el-collapse-item title="Â§ñËßÇÊ†∑Âºè" name="appearance">
                    <div class="property-grid">
                      <el-color-picker v-model="objectProperties.fill" label="Â°´ÂÖÖ:" />
                      <el-color-picker v-model="objectProperties.stroke" label="ËæπÊ°Ü:" />
                      <el-input-number v-model="objectProperties.strokeWidth" label="ËæπÊ°ÜÂÆΩÂ∫¶:" size="small" />
                      <el-input-number v-model="objectProperties.opacity" :min="0" :max="1" :step="0.1" label="ÈÄèÊòéÂ∫¶:" size="small" />
                    </div>
                  </el-collapse-item>
                </el-collapse>
              </div>
              <div v-else class="no-selection">
                <p>ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂØπË±°Êù•ÁºñËæëÂ±ûÊÄß</p>
              </div>
            </div>
          </el-tab-pane>

          <!-- ÂõæÂ±ÇÈù¢Êùø -->
          <el-tab-pane label="üìö" name="layers">
            <div class="layers-panel">
              <h4>ÂõæÂ±ÇÁÆ°ÁêÜ</h4>
              <div class="layer-list">
                <div 
                  v-for="(layer, index) in layers" 
                  :key="layer.id"
                  :class="['layer-item', { active: layer.selected, hidden: !layer.visible }]"
                  @click="selectLayer(layer)">
                  <div class="layer-info">
                    <el-icon @click.stop="toggleLayerVisibility(layer)">
                      <View v-if="layer.visible" />
                      <Hide v-else />
                    </el-icon>
                    <span class="layer-name">{{ layer.name }}</span>
                  </div>
                  <div class="layer-actions">
                    <el-icon @click.stop="duplicateLayer(layer)" title="Â§çÂà∂ÂõæÂ±Ç">
                      <CopyDocument />
                    </el-icon>
                    <el-icon @click.stop="deleteLayer(layer)" title="Âà†Èô§ÂõæÂ±Ç">
                      <Delete />
                    </el-icon>
                  </div>
                </div>
              </div>
              <el-button @click="addNewLayer" size="small" style="width: 100%; margin-top: 10px;">
                <el-icon><Plus /></el-icon>
                Êñ∞Âª∫ÂõæÂ±Ç
              </el-button>
            </div>
          </el-tab-pane>
        </el-tabs>
      </div>

      <!-- ‰∏≠Â§ÆÁºñËæëÂå∫Âüü -->
      <div class="center-area">
        <!-- ÁºñËæëÂô®Ê†áÁ≠æÈ°µ -->
        <el-tabs v-model="activeEditor" type="card" class="editor-tabs">
          <el-tab-pane label="üìù ÁºñËæë" name="edit">
            <div class="edit-area">
              <!-- MonacoÁºñËæëÂô® -->
              <div v-if="currentMode === 'text' || currentMode === 'formula'" 
                   ref="monacoContainer" 
                   class="monaco-container">
              </div>
              
              <!-- Fabric.jsÁîªÂ∏É -->
              <div v-if="currentMode === 'graphic'" class="canvas-container">
                <canvas ref="fabricCanvas" class="fabric-canvas"></canvas>
              </div>
              
              <!-- ÂõæË°®ÁºñËæëÂô® -->
              <div v-if="currentMode === 'chart'" class="chart-container">
                <div ref="chartContainer" class="chart-editor"></div>
              </div>
            </div>
          </el-tab-pane>

          <el-tab-pane label="üëÅÔ∏è È¢ÑËßà" name="preview" v-if="showPreview">
            <div class="preview-area">
              <div class="preview-content" v-html="previewContent"></div>
            </div>
          </el-tab-pane>
        </el-tabs>
      </div>

      <!-- Âè≥‰æßÈù¢Êùø -->
      <div class="right-panel" v-show="!isFullscreen">
        <el-tabs v-model="activeRightPanel" tab-position="right" class="panel-tabs">
          <!-- Ê®°ÊùøÂ∫ì -->
          <el-tab-pane label="üìã" name="templates">
            <div class="templates-panel">
              <h4>Ê®°ÊùøÂ∫ì</h4>
              <el-input v-model="templateSearch" placeholder="ÊêúÁ¥¢Ê®°Êùø..." size="small" style="margin-bottom: 10px;">
                <template #prefix>
                  <el-icon><Search /></el-icon>
                </template>
              </el-input>
              
              <div class="template-categories">
                <el-collapse v-model="activeTemplateCategories">
                  <el-collapse-item title="Êï∞Â≠¶ÂÖ¨Âºè" name="math">
                    <div class="template-grid">
                      <div v-for="template in mathTemplates" 
                           :key="template.id"
                           class="template-item"
                           @click="insertTemplate(template)">
                        <div class="template-preview" v-html="renderFormula(template.latex)"></div>
                        <div class="template-name">{{ template.name }}</div>
                      </div>
                    </div>
                  </el-collapse-item>
                  
                  <el-collapse-item title="Âá†‰ΩïÂõæÂΩ¢" name="geometry">
                    <div class="template-grid">
                      <div v-for="template in geometryTemplates" 
                           :key="template.id"
                           class="template-item"
                           @click="insertGeometryTemplate(template)">
                        <div class="template-preview">{{ template.icon }}</div>
                        <div class="template-name">{{ template.name }}</div>
                      </div>
                    </div>
                  </el-collapse-item>
                </el-collapse>
              </div>
            </div>
          </el-tab-pane>

          <!-- ÂéÜÂè≤ËÆ∞ÂΩï -->
          <el-tab-pane label="üìú" name="history">
            <div class="history-panel">
              <h4>ÁºñËæëÂéÜÂè≤</h4>
              <div class="history-list">
                <div v-for="(item, index) in editHistory" 
                     :key="index"
                     :class="['history-item', { active: index === historyIndex }]"
                     @click="restoreFromHistory(index)">
                  <div class="history-time">{{ formatTime(item.timestamp) }}</div>
                  <div class="history-action">{{ item.action }}</div>
                </div>
              </div>
            </div>
          </el-tab-pane>
        </el-tabs>
      </div>
    </div>

    <!-- Â∫ïÈÉ®Áä∂ÊÄÅÊ†è -->
    <div class="status-bar">
      <div class="status-left">
        <span>Ê®°Âºè: {{ getModeLabel(currentMode) }}</span>
        <span v-if="selectedObject">ÈÄâ‰∏≠: {{ selectedObject.type }}</span>
        <span>Áº©Êîæ: {{ Math.round(zoomLevel * 100) }}%</span>
      </div>
      
      <div class="status-right">
        <span v-if="currentMode === 'formula'">LaTeXËØ≠Ê≥ï | </span>
        <span>{{ documentStats.words }} Â≠ó | </span>
        <span>{{ documentStats.characters }} Â≠óÁ¨¶</span>
      </div>
    </div>

    <!-- Âø´Êç∑ÈîÆÂ∏ÆÂä© -->
    <el-dialog v-model="showShortcutsDialog" title="‚å®Ô∏è Âø´Êç∑ÈîÆÂ∏ÆÂä©" width="60%">
      <div class="shortcuts-help">
        <el-row :gutter="20">
          <el-col :span="12">
            <h4>ÈÄöÁî®Âø´Êç∑ÈîÆ</h4>
            <div class="shortcut-list">
              <div class="shortcut-item">
                <kbd>Ctrl + N</kbd>
                <span>Êñ∞Âª∫ÊñáÊ°£</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + S</kbd>
                <span>‰øùÂ≠òÊñáÊ°£</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + Z</kbd>
                <span>Êí§ÈîÄ</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + Y</kbd>
                <span>ÈáçÂÅö</span>
              </div>
              <div class="shortcut-item">
                <kbd>F11</kbd>
                <span>ÂÖ®Â±èÂàáÊç¢</span>
              </div>
            </div>
          </el-col>
          
          <el-col :span="12">
            <h4>ÁºñËæëÂø´Êç∑ÈîÆ</h4>
            <div class="shortcut-list">
              <div class="shortcut-item">
                <kbd>Ctrl + C</kbd>
                <span>Â§çÂà∂</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + V</kbd>
                <span>Á≤òË¥¥</span>
              </div>
              <div class="shortcut-item">
                <kbd>Delete</kbd>
                <span>Âà†Èô§ÈÄâ‰∏≠</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + A</kbd>
                <span>ÂÖ®ÈÄâ</span>
              </div>
              <div class="shortcut-item">
                <kbd>Ctrl + D</kbd>
                <span>Â§çÂà∂ÈÄâ‰∏≠</span>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, onUnmounted, nextTick, computed } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import * as monaco from 'monaco-editor'
import { fabric } from 'fabric'
import katex from 'katex'
import * as echarts from 'echarts'

// ÂõæÊ†áÂØºÂÖ•
import {
  DocumentAdd, FolderOpened, Document, Download, RefreshLeft, RefreshRight,
  View, FullScreen, Plus, CopyDocument, Delete, Search, Hide, EditPen,
  Setting, Tools, Upload, ArrowUp, ArrowDown, ArrowLeft, ArrowRight,
  TrendCharts
} from '@element-plus/icons-vue'

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const currentMode = ref('text')
const activeEditor = ref('edit')
const activePanel = ref('tools')
const activeRightPanel = ref('templates')
const showPreview = ref(false)
const isFullscreen = ref(false)
const showShortcutsDialog = ref(false)

// ÁºñËæëÂô®ÂÆû‰æã
const monacoEditor = ref(null)
const fabricCanvas = ref(null)
const chartInstance = ref(null)

// ÁºñËæëÁä∂ÊÄÅ
const canUndo = ref(false)
const canRedo = ref(false)
const isSaving = ref(false)
const selectedObject = ref(null)
const zoomLevel = ref(1)

// ÊñáÊ°£ÁªüËÆ°
const documentStats = reactive({
  words: 0,
  characters: 0,
  lines: 0
})

// ÁºñËæëÂéÜÂè≤
const editHistory = ref([])
const historyIndex = ref(-1)

// Ê®°ÊùøÊêúÁ¥¢
const templateSearch = ref('')
const activeTemplateCategories = ref(['math', 'geometry'])
const activePropertyGroups = ref(['transform', 'appearance'])

// ÂõæÂ±ÇÁÆ°ÁêÜ
const layers = ref([
  { id: 1, name: 'ÂõæÂ±Ç 1', visible: true, selected: true }
])

// ÂØπË±°Â±ûÊÄß
const objectProperties = reactive({
  x: 0,
  y: 0,
  width: 100,
  height: 100,
  rotation: 0,
  fill: '#ffffff',
  stroke: '#000000',
  strokeWidth: 1,
  opacity: 1
})

// ËÆ°ÁÆóÂ±ûÊÄß
const multipleSelected = computed(() => {
  // ÂÆûÁé∞Â§öÈÄâÈÄªËæë
  return false
})

const previewContent = computed(() => {
  // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèÁîüÊàêÈ¢ÑËßàÂÜÖÂÆπ
  if (currentMode.value === 'formula' && monacoEditor.value) {
    const content = monacoEditor.value.getValue()
    return renderFormula(content)
  }
  return ''
})

// Êï∞Â≠¶Ê®°Êùø
const mathTemplates = [
  { id: 1, name: '‰∫åÊ¨°ÂÖ¨Âºè', latex: 'x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}' },
  { id: 2, name: 'Ê¨ßÊãâÂÖ¨Âºè', latex: 'e^{i\\pi} + 1 = 0' },
  { id: 3, name: 'Ê≥∞ÂãíÂ±ïÂºÄ', latex: 'f(x) = \\sum_{n=0}^{\\infty} \\frac{f^{(n)}(a)}{n!}(x-a)^n' }
]

// Âá†‰ΩïÊ®°Êùø
const geometryTemplates = [
  { id: 1, name: 'Áõ¥Ëßí‰∏âËßíÂΩ¢', icon: '‚ñ≥', type: 'triangle' },
  { id: 2, name: 'Ê≠£ÊñπÂΩ¢', icon: '‚ñ°', type: 'square' },
  { id: 3, name: 'ÂúÜÂΩ¢', icon: '‚óã', type: 'circle' }
]

// ÊñπÊ≥ïÂÆûÁé∞
const newDocument = () => {
  ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÊñ∞Âª∫ÊñáÊ°£ÂêóÔºüÊú™‰øùÂ≠òÁöÑÊõ¥ÊîπÂ∞Ü‰∏¢Â§±„ÄÇ', 'Á°ÆËÆ§', {
    type: 'warning'
  }).then(() => {
    // Ê∏ÖÁ©∫ÁºñËæëÂô®
    if (monacoEditor.value) {
      monacoEditor.value.setValue('')
    }
    if (fabricCanvas.value) {
      fabricCanvas.value.clear()
    }
    ElMessage.success('Êñ∞Âª∫ÊñáÊ°£ÊàêÂäü')
  }).catch(() => {})
}

const openDocument = () => {
  ElMessage.info('ÊâìÂºÄÊñáÊ°£ÂäüËÉΩ')
}

const exportDocument = () => {
  ElMessage.info('ÂØºÂá∫ÊñáÊ°£ÂäüËÉΩ')
}

const undo = () => {
  if (canUndo.value) {
    ElMessage.info('Êí§ÈîÄÊìç‰Ωú')
    canUndo.value = false
    canRedo.value = true
  }
}

const redo = () => {
  if (canRedo.value) {
    ElMessage.info('ÈáçÂÅöÊìç‰Ωú')
    canRedo.value = false
    canUndo.value = true
  }
}

const switchMode = (mode) => {
  currentMode.value = mode
  ElMessage.success(`ÂàáÊç¢Âà∞${getModeLabel(mode)}Ê®°Âºè`)
}

const togglePreview = () => {
  showPreview.value = !showPreview.value
}

const toggleFullscreen = () => {
  isFullscreen.value = !isFullscreen.value
}

const insertText = (text) => {
  if (monacoEditor.value) {
    const selection = monacoEditor.value.getSelection()
    monacoEditor.value.executeEdits('', [{
      range: selection,
      text: text
    }])
  }
}

const insertFormula = (formula) => {
  insertText(formula)
}

const addShape = (shapeType) => {
  ElMessage.info(`Ê∑ªÂä†${shapeType}ÂΩ¢Áä∂`)
}

const selectLayer = (layer) => {
  layers.value.forEach(l => l.selected = false)
  layer.selected = true
}

const toggleLayerVisibility = (layer) => {
  layer.visible = !layer.visible
}

const duplicateLayer = (layer) => {
  const newLayer = { ...layer, id: Date.now(), name: layer.name + ' ÂâØÊú¨' }
  layers.value.push(newLayer)
}

const deleteLayer = (layer) => {
  const index = layers.value.findIndex(l => l.id === layer.id)
  if (index > -1) {
    layers.value.splice(index, 1)
  }
}

const addNewLayer = () => {
  const newLayer = {
    id: Date.now(),
    name: `ÂõæÂ±Ç ${layers.value.length + 1}`,
    visible: true,
    selected: false
  }
  layers.value.push(newLayer)
}

const insertTemplate = (template) => {
  insertFormula(template.latex)
}

const insertGeometryTemplate = (template) => {
  addShape(template.type)
}

const restoreFromHistory = (index) => {
  historyIndex.value = index
  ElMessage.info(`ÊÅ¢Â§çÂà∞ÂéÜÂè≤ËÆ∞ÂΩï ${index + 1}`)
}

// openDocument Â∑≤Âú®‰∏äÈù¢ÂÆö‰πâÔºåÂà†Èô§ÈáçÂ§çÂ£∞Êòé

const exportDocument = () => {
  ElMessage.info('ÂØºÂá∫ÊñáÊ°£ÂäüËÉΩÂºÄÂèë‰∏≠...')
}

const undo = () => {
  if (canUndo.value) {
    ElMessage.success('Êí§ÈîÄÊìç‰Ωú')
    canUndo.value = false
    canRedo.value = true
  }
}

const redo = () => {
  if (canRedo.value) {
    ElMessage.success('ÈáçÂÅöÊìç‰Ωú')
    canRedo.value = false
    canUndo.value = true
  }
}

const switchMode = (mode) => {
  currentMode.value = mode
  ElMessage.success(`ÂàáÊç¢Âà∞${getModeLabel(mode)}Ê®°Âºè`)
}

const togglePreview = () => {
  showPreview.value = !showPreview.value
}

const toggleFullscreen = () => {
  isFullscreen.value = !isFullscreen.value
}

const insertText = (text) => {
  if (monacoEditor.value) {
    const selection = monacoEditor.value.getSelection()
    monacoEditor.value.executeEdits('', [{
      range: selection,
      text: text
    }])
  }
}

const insertFormula = (formula) => {
  insertText(`$$${formula}$$`)
}

const addShape = (shapeType) => {
  ElMessage.success(`Ê∑ªÂä†${shapeType}ÂΩ¢Áä∂`)
}

const selectLayer = (layer) => {
  layers.value.forEach(l => l.selected = false)
  layer.selected = true
}

const toggleLayerVisibility = (layer) => {
  layer.visible = !layer.visible
}

const duplicateLayer = (layer) => {
  const newLayer = {
    ...layer,
    id: Date.now(),
    name: layer.name + ' ÂâØÊú¨',
    selected: false
  }
  layers.value.push(newLayer)
}

const deleteLayer = (layer) => {
  const index = layers.value.indexOf(layer)
  if (index > -1) {
    layers.value.splice(index, 1)
  }
}

const addNewLayer = () => {
  const newLayer = {
    id: Date.now(),
    name: `ÂõæÂ±Ç ${layers.value.length + 1}`,
    visible: true,
    selected: false
  }
  layers.value.push(newLayer)
}

const insertTemplate = (template) => {
  if (currentMode.value === 'formula') {
    insertFormula(template.latex)
  }
}

const insertGeometryTemplate = (template) => {
  addShape(template.type)
}

const restoreFromHistory = (index) => {
  historyIndex.value = index
  ElMessage.success(`ÊÅ¢Â§çÂà∞ÂéÜÂè≤ËÆ∞ÂΩï ${index + 1}`)
}

const saveDocument = async () => {
  isSaving.value = true
  try {
    // ÂÆûÁé∞‰øùÂ≠òÈÄªËæë
    await new Promise(resolve => setTimeout(resolve, 1000)) // Ê®°Êãü‰øùÂ≠ò
    ElMessage.success('ÊñáÊ°£‰øùÂ≠òÊàêÂäü')
  } catch (error) {
    ElMessage.error('‰øùÂ≠òÂ§±Ë¥•: ' + error.message)
  } finally {
    isSaving.value = false
  }
}

const renderFormula = (formula) => {
  if (!formula) return ''
  try {
    return katex.renderToString(formula, {
      throwOnError: false,
      displayMode: true,
      strict: false,
      trust: true
    })
  } catch (error) {
    return `<span class="formula-error">ÂÖ¨ÂºèÈîôËØØ: ${error.message}</span>`
  }
}

const getModeLabel = (mode) => {
  const labels = {
    text: 'ÊñáÊú¨ÁºñËæë',
    graphic: 'ÂõæÂΩ¢ËÆæËÆ°', 
    formula: 'ÂÖ¨ÂºèÁºñËæë',
    chart: 'ÂõæË°®Âà∂‰Ωú',
    component: 'ÁªÑ‰ª∂ÁªÑÂêà'
  }
  return labels[mode] || mode
}

const formatTime = (timestamp) => {
  return new Date(timestamp).toLocaleTimeString()
}

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
  // ÂàùÂßãÂåñÁºñËæëÂô®
  initializeEditors()
  
  // ÁªëÂÆöÂø´Êç∑ÈîÆ
  document.addEventListener('keydown', handleKeydown)
})

onUnmounted(() => {
  document.removeEventListener('keydown', handleKeydown)
})

// Âø´Êç∑ÈîÆÂ§ÑÁêÜ
const handleKeydown = (event) => {
  if (event.ctrlKey) {
    switch (event.key) {
      case 'n':
        event.preventDefault()
        newDocument()
        break
      case 's':
        event.preventDefault()
        saveDocument()
        break
      case 'z':
        event.preventDefault()
        undo()
        break
      case 'y':
        event.preventDefault()
        redo()
        break
    }
  }
  
  if (event.key === 'F11') {
    event.preventDefault()
    toggleFullscreen()
  }
}

// ÂàùÂßãÂåñÁºñËæëÂô®
const initializeEditors = async () => {
  // ÂàùÂßãÂåñMonacoÁºñËæëÂô®
  if (currentMode.value === 'text' || currentMode.value === 'formula') {
    // MonacoÁºñËæëÂô®ÂàùÂßãÂåñÈÄªËæë
  }

  // ÂàùÂßãÂåñFabric.jsÁîªÂ∏É
  if (currentMode.value === 'graphic') {
    // Fabric.jsÁîªÂ∏ÉÂàùÂßãÂåñÈÄªËæë
  }

  // ÂàùÂßãÂåñEChartsÂõæË°®
  if (currentMode.value === 'chart') {
    // EChartsÂõæË°®ÂàùÂßãÂåñÈÄªËæë
  }
}

// ÂØºÂá∫ÁªÑ‰ª∂
defineExpose({
  newDocument,
  saveDocument,
  undo,
  redo
})
</script>

<style scoped>
.enhanced-editor {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #f5f5f5;
}

.main-toolbar {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 10px 20px;
  background: white;
  border-bottom: 1px solid #e0e0e0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.toolbar-section {
  display: flex;
  align-items: center;
  gap: 10px;
}

.editor-body {
  flex: 1;
  display: flex;
  overflow: hidden;
}

.editor-body.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: white;
}

.left-panel, .right-panel {
  width: 280px;
  background: white;
  border-right: 1px solid #e0e0e0;
}

.right-panel {
  border-right: none;
  border-left: 1px solid #e0e0e0;
}

.center-area {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.monaco-container, .canvas-container, .chart-container {
  height: 100%;
  width: 100%;
}

.fabric-canvas {
  border: 1px solid #ddd;
}

.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 20px;
  background: #f8f9fa;
  border-top: 1px solid #e0e0e0;
  font-size: 12px;
  color: #666;
}

.tool-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 5px;
  margin-bottom: 15px;
}

.template-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.template-item {
  padding: 10px;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.template-item:hover {
  border-color: #409eff;
  background: #f0f9ff;
}

.shortcut-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
}

kbd {
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 3px;
  padding: 2px 6px;
  font-family: monospace;
  font-size: 11px;
}

.formula-error {
  color: #f56565;
  font-size: 12px;
  font-style: italic;
}
</style>
